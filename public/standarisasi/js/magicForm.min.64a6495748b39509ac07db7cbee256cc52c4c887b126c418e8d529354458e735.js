import{auth,db,doc,setDoc,updateDoc,getDoc}from"/js/firebaseConfig.js";document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".magic-form"),t=e=>{if(e.type==="checkbox")return Array.from(document.querySelectorAll(`input[name="${e.name}"]:checked`)).map(e=>e.value);if(e.type==="radio"){const t=document.querySelector(`input[name="${e.name}"]:checked`);return t?t.value:null}return e.type==="number"?Number(e.value):e.value},n=async(e,n)=>{e.preventDefault();const i=e.target,s=n.querySelector(".status-message"),o=i.querySelector('button[type="submit"]');try{const r=auth.currentUser;if(!r)throw new Error("Silakan login terlebih dahulu");o.disabled=!0,o.innerHTML='<div class="spinner"></div> Menyimpan...';const h=n.dataset.koleksi,l=n.dataset.namaKomponen,m=n.dataset.dokumen,c={},d=i.elements;Array.from(d).forEach(e=>{e.name&&!["submit","button"].includes(e.type)&&(c[e.name]=t(e))});const e=new Date,a={...c,metadata:{createdAt:e,updatedAt:e,userId:r.uid,komponen:l}},u=await getDoc(docRef);u.exists()?(a.metadata.updatedAt=e,await updateDoc(docRef,a)):await setDoc(docRef,a),s.textContent="✅ Data berhasil disimpan!",s.className="status-message success",n.dataset.redirect&&setTimeout(()=>{window.location.href=n.dataset.redirect},1500)}catch(e){console.error("Error:",e),s.innerHTML=`❌ Gagal menyimpan: <em>${e.message}</em>`,s.className="status-message error"}finally{s.style.display="block",o.disabled=!1,o.textContent="Simpan",setTimeout(()=>{s.style.display="none"},3e3)}};e.forEach(e=>{const t=e.closest(".magic-form-container");e.addEventListener("submit",e=>n(e,t))})})